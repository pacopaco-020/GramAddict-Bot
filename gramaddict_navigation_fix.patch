#!/bin/bash
# GramAddict Navigation Bug Fix Patch
# Fixes the "'Iter' object is not iterable" error in navigate_to_main_account

echo "🔧 Applying GramAddict Navigation Bug Fix..."

# Backup the original views.py file
cp GramAddict/core/views.py GramAddict/core/views.py.backup
echo "✅ Backup created: GramAddict/core/views.py.backup"

# Create the fixed navigate_to_main_account method
cat > /tmp/navigation_fix.py << 'EOF'
    def navigate_to_main_account(self):
        """Navigate to main account - Fixed version to avoid Iter bug"""
        try:
            logger.debug("Navigating to main account...")
            
            # Simple approach: try to click on profile tab
            profile_tab = self.device.find(
                resourceId="com.instagram.android:id/profile_tab"
            )
            if profile_tab.exists():
                profile_tab.click()
                random_sleep(1, 2)
                logger.debug("Clicked on profile tab")
                return
            
            # Fallback: try coordinate-based navigation for v300
            # Profile tab is typically at bottom right
            screen_width = self.device.screen_width if hasattr(self.device, 'screen_width') else 1080
            screen_height = self.device.screen_height if hasattr(self.device, 'screen_height') else 2088
            
            # Calculate profile tab position (bottom right area)
            profile_x = int(screen_width * 0.8)  # 80% from left
            profile_y = int(screen_height * 0.95)  # 95% from top
            
            logger.debug(f"Trying coordinate click at ({profile_x}, {profile_y})")
            self.device.click(profile_x, profile_y)
            random_sleep(1, 2)
            
        except Exception as e:
            logger.warning(f"navigate_to_main_account failed: {e}")
            logger.warning("Continuing without navigation - account might already be correct")
            # Don't crash - just continue
            pass
EOF

# Find the line number where navigate_to_main_account starts
NAVIGATE_LINE=$(grep -n "def navigate_to_main_account" GramAddict/core/views.py | cut -d: -f1)

if [ -z "$NAVIGATE_LINE" ]; then
    echo "❌ Could not find navigate_to_main_account method in views.py"
    exit 1
fi

echo "📍 Found navigate_to_main_account at line $NAVIGATE_LINE"

# Find the end of the method (next def or class)
END_LINE=$(tail -n +$((NAVIGATE_LINE + 1)) GramAddict/core/views.py | grep -n -E "^    def |^class " | head -1 | cut -d: -f1)
if [ -n "$END_LINE" ]; then
    END_LINE=$((NAVIGATE_LINE + END_LINE))
else
    # If no next method found, assume it goes to end of file
    END_LINE=$(wc -l < GramAddict/core/views.py)
fi

echo "📍 Method ends around line $END_LINE"

# Create new file with the fix
head -n $((NAVIGATE_LINE - 1)) GramAddict/core/views.py > /tmp/views_fixed.py
cat /tmp/navigation_fix.py >> /tmp/views_fixed.py
tail -n +$((END_LINE)) GramAddict/core/views.py >> /tmp/views_fixed.py

# Replace the original file
mv /tmp/views_fixed.py GramAddict/core/views.py

# Add required import if not present
if ! grep -q "from GramAddict.core.utils import random_sleep" GramAddict/core/views.py; then
    # Find import section and add our import
    sed -i '1i from GramAddict.core.utils import random_sleep' GramAddict/core/views.py
fi

echo "✅ Navigation fix applied successfully!"
echo "🎯 The 'Iter' object is not iterable error should now be resolved"
echo ""
echo "📋 To revert the fix if needed:"
echo "   cp GramAddict/core/views.py.backup GramAddict/core/views.py"
echo ""
echo "🚀 You can now run the bot normally!"

# Cleanup
rm -f /tmp/navigation_fix.py
